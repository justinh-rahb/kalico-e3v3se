From 2e08a2c2c2b497f498311d553fc0fc6d4e2e1e21 Mon Sep 17 00:00:00 2001
From: Joao Curti <jpcurti@users.noreply.github.com>
Date: Mon, 27 May 2024 21:41:26 +0200
Subject: [PATCH 31/43]  Configure serial bridge as part of e3v3se display

---
 klippy/extras/e3v3se_display.py | 17 +++++++++++++++--
 klippy/extras/serial_bridge.py  |  6 ++++++
 2 files changed, 21 insertions(+), 2 deletions(-)

diff --git a/klippy/extras/e3v3se_display.py b/klippy/extras/e3v3se_display.py
index 891e07a43..336985e2f 100644
--- a/klippy/extras/e3v3se_display.py
+++ b/klippy/extras/e3v3se_display.py
@@ -25,6 +25,13 @@ class E3v3seDisplay:
         # register for key events
         menu_keys.MenuKeys(config, self.key_event)
 
+        bridge = config.get('serial_bridge')
+
+        self.serial_bridge = self.printer.lookup_object(
+            'serial_bridge %s' %(bridge))
+        self.serial_bridge.register_callback(
+            self._handle_serial_bridge_response)
+
         self._update_interval = 1
         self._update_timer = self.reactor.register_timer(self._screen_update)
 
@@ -51,10 +58,16 @@ class E3v3seDisplay:
 
     def encoder_has_data(self):
         self.log("Key event")
-        return 
+    
+    def _handle_serial_bridge_response(self, data):
+        byte_debug = ' '.join(['0x{:02x}'.format(byte) for byte in data])
+        self.log("Received message: " + byte_debug)
+    
+    def send_text(self, text):
+        self.serial_bridge.send_text(text)
 
     def _screen_update(self, eventtime):
-        #self.log("Display update: ")
+        self.log("Display update")
         return eventtime + self._update_interval
 
     def _screen_init(self, eventtime):
diff --git a/klippy/extras/serial_bridge.py b/klippy/extras/serial_bridge.py
index 512495de1..fed7fab41 100644
--- a/klippy/extras/serial_bridge.py
+++ b/klippy/extras/serial_bridge.py
@@ -127,6 +127,12 @@ class PrinterSerialBridge:
 
     def send_text(self, msg):
         self.send_serial(msg.encode('utf-8'))
+    
+    def send_bytes(self, msg):
+        byte_debug = ' '.join(['0x{:02x}'.format(byte) for byte in msg])
+        self.log("Sending bytes: " + byte_debug)
+        self.serial_bridge_send_cmd.send([self.oid, msg, 4])
+
 
     def send_serial(self, msg):
         if not self._ready:
-- 
2.39.5 (Apple Git-154)

